{"version":3,"sources":["unicom.js"],"names":["$","parseThxd","msg","find","each","data","first","this","replace","text","datas","monthData","get","log","JSON","stringify","getThxdByAjax","year","month","curMonthData","parseInt","session","ajax","url","type","success","totalrow","loadMore","thxd","set","error","xhr","spide","_this","beginrow","endrow","href","pagenum","params","load","monthArr","length","setProgress","monthObj","window","location","endSpide","upload","showProgress","indexOf","curMonth","date","getFullYear","curYear","i","push","max","infoTag","userInfo","html","e","len"],"mappings":"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","file":"../unicom.js","sourcesContent":["dSpider(\"unicom\", 60*5, function(session,env,$){\n\n    function parseThxd(msg) {\n        $(msg).find(\"tr.tips_dial\").each(function() {\n            var data = {}\n            data[\"otherNo\"] = $(this).find(\"label.telphone\").text();\n            data[\"callTime\"] = $(this).find(\"td:eq(1) p\").first().text();\n            data[\"callFee\"] = $(this).find(\"p.time:eq(0)\").text().replace(/[\\n|\\s]/g, \"\").replace();\n            data[\"callBeginTime\"] = $(this).find(\"p.time:eq(1)\").text().replace(/[\\n|\\s]/g, \"\").replace();\n            data[\"callType\"] = ($(this).find(\".call_out\").length == 1) ? \"主叫\" : \"被叫\";\n\n            var monthData = session.get(\"curMonthData\")\n            var datas = monthData[\"data\"]\n            if(!datas) {\n                datas = []\n            }\n            datas.push(data)\n            monthData[\"data\"] = datas;\n            session.set(\"curMonthData\", monthData)\n            log(\"获取一条数据：\" + JSON.stringify(data))\n        })\n    }\n\n    function getThxdByAjax(year, month) {\n        log(\"开始爬取【\" + month + \"】月份通话详单：\")\n        //session.upload(\"开始爬取【\" + month + \"】月份通话详单：\")\n        var curMonthData = {}\n        curMonthData[\"calldate\"] = year + \"\" + month\n        curMonthData[\"cid\"] = parseInt(new Date().getTime()/1000).toString()\n        session.set(\"curMonthData\", curMonthData)\n        $.ajax({\n            url: '/mobileService/query/getPhoneByDetailContent.htm',\n            type: 'post',\n            data: 't=' + new Date().getTime() + '&YYYY=' + year + '&MM=' + month + '&DD=&queryMonthAndDay=month&menuId=',\n            //dataType: 'html',\n            //async: true,\n            //cache: false,\n            success: function(msg) {\n                log(\"请求\" + month + \"月份数据成功....\")\n                parseThxd(msg);\n                $('#pageNew').html(msg);\n                //保存数据\n                var data = session.get(\"curMonthData\")\n                data[\"totalCount\"] = totalrow\n                data[\"status\"] = 4\n                session.set(\"curMonthData\", data)\n\n                //是否需要加载更多\n                if (endrow < totalrow) {\n                    loadMore();\n                } else {\n                    var thxd = session.get(\"thxd\")\n                    if(!thxd) {\n                        thxd = {};\n                        thxd[\"month_status\"] = [];\n                    }\n                    thxd[\"month_status\"].push(data)\n                    session.set(\"thxd\", thxd)\n                    session.set(\"curMonthData\", \"\")\n                    log(\"爬取数据完成...\" + JSON.stringify(data))\n                    spide();\n                }\n            },\n            error: function(xhr, msg){\n                //保存数据\n                var data = session.get(\"curMonthData\")\n                data[\"totalCount\"] = 0\n                data[\"status\"] = 2\n                data[\"data\"] = []\n                var thxd = session.get(\"thxd\")\n                if(!thxd) {\n                    thxd = {};\n                    thxd[\"month_status\"] = [];\n                }\n                thxd[\"month_status\"].push(data)\n                session.set(\"thxd\", thxd)\n                session.set(\"curMonthData\", \"\")\n\n                log(\"爬取【\" + month + \"】月份通话详单失败！\")\n                spide();\n            }\n        });\n    }\n\n    function loadMore() {\n        log(\"加载更多...\")\n        var _this = $(this);\n        var beginrow = endrow;\n        endrow = beginrow + perrow;\n        if (endrow > totalrow) {\n            endrow = totalrow;\n        }\n        _this.html('<img src=\"http://img.client.10010.com/mobileService/view/client/images/loading.gif\" width=\"16\">');\n        var href = '/mobileService/view/client/query/xdcx/thxd_more_list.jsp?1=1&t=' + getrandom();\n        var params = '&beginrow=' + beginrow + '&endrow=' + endrow + '&pagenum=' + (pagenum + 1);\n        $('.moredetail' + pagenum).load(href + params, function(msg) {\n            parseThxd(msg);\n            var thxd = session.get(\"thxd\")\n            if(!thxd) {\n                thxd = {};\n                thxd[\"month_status\"] = [];\n            }\n            thxd[\"month_status\"].push(session.get(\"curMonthData\"))\n            session.set(\"thxd\", thxd)\n            session.set(\"curMonthData\", \"\")\n            //继续爬取\n            spide();\n        });\n    }\n\n    function spide() {\n        var monthArr = session.get(\"months\")\n        if (monthArr && monthArr.length > 0) {\n            session.setProgress(session.get(\"max\") - monthArr.length - 1)\n            var monthObj = monthArr.shift();\n            session.set(\"months\", monthArr)\n            getThxdByAjax(monthObj.year, monthObj.month);\n        } else {\n            var thxd = session.get(\"thxd\")\n            log(\"爬取通话详单完毕----------\" + JSON.stringify(thxd))\n            //跳转到服务首页\n            window.location.href = \"http://wap.10010.com/mobileService/siteMap.htm\"\n        }\n    }\n\n    function endSpide(thxd) {\n        log(\"爬取完毕----------\" + JSON.stringify(thxd))\n        session.upload(JSON.stringify(thxd))\n        session.setProgress(session.get(\"max\") - 0)\n        session.finish()\n        session.showProgress(false)\n    }\n\n    if(window.location.href.indexOf(\"/uac.10010.com/oauth2/new_auth\") != -1) {\n        session.showProgress(false)\n    } if(window.location.href.indexOf('query/getPhoneByDetailTip.htm') != -1){\n        //显示loading\n        session.showProgress()\n\n        //计算月份信息\n        var date = new Date();\n        var curMonth = date.getMonth() + 1;\n        var curYear = date.getFullYear();\n        var monthArr = []\n        for (var i = 0; i < 6; i++) {\n            var month = curMonth - i;\n            var year = curYear;\n            if (month < 1) {\n                month += 12;\n                year -= 1;\n            }\n            if (month < 10) {\n                month = \"0\" + month;\n            }\n            monthArr.push({ \"year\": year, \"month\": month });\n        }\n        var max = monthArr.length + 1;\n        //设置月份信息\n        session.set(\"months\", monthArr)\n        session.set(\"max\", max)\n        session.setProgressMax(max)\n        log(\"开始爬取.....\" + JSON.stringify(monthArr))\n        spide()\n    } else if(window.location.href.indexOf('mobileService/siteMap.htm') != -1){//服务界面，获取个人信息跳转\n        var infoTag = \"\"\n        $(\".checklistcontainer.newmore\").find(\"li\").each(function(){\n            if($(this).html().indexOf(\"基本信息\") != -1) {\n                infoTag = $(this)\n                return\n            }\n        });\n        if(infoTag) {\n            //跳转到我的基本信息页面\n            window.location.href = infoTag.attr(\"name\")\n        } else {\n            log(\"用户信息获取失败.....\")\n            var thxd = session.get(\"thxd\")\n            thxd[\"user_info\"] = {}\n            endSpide(thxd)\n        }\n    } else if(window.location.href.indexOf(\"t/operationservice/getUserinfo.htm\") !=-1 ) {//获取个人信息\n        log(\"开始爬取用户信息----------\")\n        var userInfo = {}\n        try {\n            userInfo[\"mobile\"] = $(\".clientInfo4_top\").find(\"p:eq(0)\").html().replace(/[\\n|\\s]/g, \"\").replace()\n        } catch (e) {\n        }\n        try{\n            userInfo[\"name\"] = $(\".clientInfo4_list\").find(\"li:eq(0)\").find(\"span:eq(1)\").html().replace(/[\\n|\\s]/g, \"\").replace()\n        } catch (e) {\n        }\n        try{\n            userInfo[\"taocan\"] = $(\".clientInfo4_list\").find(\"li:eq(1)\").find(\"span:eq(1)\").html().replace(/[\\n|\\s]/g, \"\").replace()\n        } catch (e) {\n        }\n        try{\n            userInfo[\"registration_time\"] = $(\".detail_con.con_ft:eq(0)\").find(\"p:eq(6)\").find(\"span:eq(1)\").text().replace(/[\\n|\\s]/g, \"\").replace()\n        } catch (e) {\n        }\n        try{\n            userInfo[\"idcard_no\"] = $(\".detail_con.con_ft:eq(1)\").find(\"p:eq(4)\").find(\"span:eq(1)\").text().replace(/[\\n|\\s]/g, \"\").replace()\n        } catch (e) {\n        }\n        try{\n            userInfo[\"household_address\"] = $(\".detail_con.con_ft:eq(1)\").find(\"p:eq(18)\").find(\"span:eq(1)\").text().replace(/[\\n|\\s]/g, \"\").replace()\n        } catch (e) {\n        }\n        log(\"爬取用户信息结束-----\" + JSON.stringify(userInfo))\n        var thxd = session.get(\"thxd\")\n        thxd[\"user_info\"] = userInfo\n        var len = thxd[\"month_status\"].length;\n        for(var i = 0; i < len; i ++) {\n            thxd[\"month_status\"][i][\"mobile\"] = userInfo[\"mobile\"]\n        }\n        endSpide(thxd)\n    }\n})"]}