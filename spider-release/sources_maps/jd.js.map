{"version":3,"sources":["jd.js"],"names":["globalInfo","$","getJSON","page","orders","order_detail","length","order_info","d","orderList","orderId","compare","saveInfo","getPageOrder","getUserInfo","tempOrder","log","max_order_num","slice","each","e","async","i","passKeyList","sid","success","addr","response","append","orderitem","order","find","dataSubmit","products","push","product","price","trim","k","max_order_date","text","num","Date","getTime","done","session","setProgress","sort","a","b","location","time","split","value2","value1","href","get","base_info","finish","infokey","set","site_id","contact_info","this","contact_detail","id","name","address","phone","zipcode","total","number","showProgress","setProgressMax","autoLoadImg","undefined","info","global_contact_info","urlarray","taskAddr","status","node","value","innerHTML","when","apply","getOrder","indexOf","click","logout","idcard_no","attr","setStartUrl"],"mappings":"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","file":"../jd.js","sourcesContent":["\ndSpider(\"jd\", function(session,env,$){\n\n    var re = /sid=(.+)$/ig;\n    var infokey = \"infokey\";\n    var sid = \"\";\n    var max_order_num = 30;\n    var max_order_date = 1000;\n    var globalInfo;\n\n    sid = session.get(\"sid\");\n\n    if (location.href.indexOf(\"://m.jd.com\") != -1 ) {\n        session.showProgress(true);\n        session.setProgressMax(100);\n        session.autoLoadImg(false);\n        session.setProgress(5);\n\n        if($(\".jd-search-form-input\")[0] != undefined){\n            sid  = $(\".jd-search-form-input\")[0].children[0].value;\n            session.set(\"sid\",  sid);\n         }\n\n        session.set(infokey, new info({},{},{}));\n        globalInfo = session.get(infokey);\n        globalInfo.base_info.username  = $(\"[report-eventid$='MCommonHTail_Account']\").text().replace(/\\n/g,\"\").replace(/\\t/g,\"\");\n        saveInfo();\n        session.setProgress(10);\n        location.href=\"http://home.m.jd.com/maddress/address.action?\";\n    }\n\n    if (location.href.indexOf(\"://home.m.jd.com/maddress\") != -1) {\n        session.setProgress(20);\n\n        globalInfo = session.get(infokey);\n\n        global_contact_info = new contact_info([]);\n        var taskAddr = [];\n        var urlarray = $(\".ia-r\");\n        for(var i=0;i<urlarray.length;i++){\n                                    taskAddr.push($.get(urlarray[i],function(response,status){\n                                    var node = $(\"<div>\").append($(response))\n                                    var name = $.trim(node.find(\"#uersNameId\")[0].value);\n                                    var phone = $.trim(node.find(\"#mobilePhoneId\")[0].value);\n                                    var addr = $.trim(node.find(\"#addressLabelId\")[0].innerHTML);\n                                    var detail = $.trim(node.find(\"#address_where\")[0].innerHTML);\n\n                                    global_contact_info.contact_detail.push(new contact(name,addr,detail,phone, \"\"));\n                                    }) );\n\n            }\n\n\n          $.when.apply($,taskAddr).done(\n       // $.when(taskAddr).done(\n                  function(){\n                        globalInfo.contact_info = global_contact_info;\n                        saveInfo();\n                        session.setProgress(30);\n                        getOrder();\n                        });\n\n\n    }\n\n\n    function getOrder(){\n        session.setProgress(40);\n        globalInfo = session.get(infokey);\n        var orders = new order_info([]);\n        globalInfo.order_info = new order_info([]);\n        globalInfo.order_info.order_detail = [];\n        function getPageOrder(page){\n           $.getJSON(\"https://home.m.jd.com//newAllOrders/newAllOrders.json?sid=\"+sid+\"&page=\"+page,function(d){\n               page++;\n               if( globalInfo.order_info.order_detail.length <=  max_order_num && d.orderList.length!=0 && (orders.order_detail.length == 0 || d.orderList[d.orderList.length-1].orderId != orders.order_detail[orders.order_detail.length-1].orderId) ){\n                   orders.order_detail = orders.order_detail.concat(d.orderList);\n                   var task = [];\n                   var tempOrder = [];\n                   if(globalInfo.order_info.order_detail.length < max_order_num){\n                        if(d.orderList.length + globalInfo.order_info.order_detail.length > max_order_num){\n                           d.orderList = d.orderList.slice(0, max_order_num -  globalInfo.order_info.order_detail.length);\n                        }\n                        task.push($.each(d.orderList,function(i,e){\n                                            log(\"task push orderId: \" + d.orderList[i].orderId);\n\n//                                           $.get(\"https://home.m.jd.com/newAllOrders/queryOrderDetailInfo.action?orderId=\"+ d.orderList[i].orderId+\"&from=newUserAllOrderList&passKey=\"+d.passKeyList[i]+\"&sid=\"+sid,\n//                                                   function(response,status){\n//                                                        log(\"orderId: \" + d.orderList[i].orderId);\n//                                                        var addr = $(\"<div>\").append($(response)).find(\".step2-in-con\").text();\n//                                                        var orderitem = new order(d.orderList[i].orderId,d.orderList[i].dataSubmit,d.orderList[i].price,addr);\n//\n//                                                        orderitem.products = [];\n//                                                        var products = $(\"<div>\").append($(response)).find(\".pdiv\");\n//                                                        $.each(products,function(k, e){\n//                                                                                                       var name = $(\"<div>\").append(products[k]).find(\".sitem-m-txt\").text();\n//                                                                                                       var price = $(\"<div>\").append(products[k]).find(\".sitem-r\").text();\n//                                                                                                       var num = $(\"<div>\").append(products[k]).find(\".s3-num\").text();\n//                                                                                                       orderitem.products.push(new product(name,  num ,price));\n//                                                         });\n//                                                         if(Date.parse(new Date()) < ((new Date(orderitem.time.split(\" \")[0])).getTime() + max_order_date * 24 * 60 * 60 * 1000)){\n//                                                              if(globalInfo.order_info.order_detail.length < max_order_num){\n//                                                                   globalInfo.order_info.order_detail.push(orderitem);\n//                                                              }\n//                                                            }\n//                                                        });\n                                            $.ajax({\n                                                      type : \"get\",\n                                                      url : \"https://home.m.jd.com/newAllOrders/queryOrderDetailInfo.action?orderId=\"+ d.orderList[i].orderId+\"&from=newUserAllOrderList&passKey=\"+d.passKeyList[i]+\"&sid=\"+sid,\n                                                      async : false,\n                                                      success : function(response){\n                                                        log(\"orderId: \" + d.orderList[i].orderId);\n                                                         var addr = $.trim($(\"<div>\").append($(response)).find(\".step2-in-con\").text());\n                                                         var orderitem = new order(d.orderList[i].orderId,d.orderList[i].dataSubmit,d.orderList[i].price,addr);\n\n                                                         orderitem.products = [];\n                                                         var products = $(\"<div>\").append($(response)).find(\".pdiv\");\n                                                         $.each(products,function(k, e){\n                                                                var name = $.trim($(\"<div>\").append(products[k]).find(\".sitem-m-txt\").text());\n                                                                var price = $.trim($(\"<div>\").append(products[k]).find(\".sitem-r\").text());\n                                                                var num = $.trim($(\"<div>\").append(products[k]).find(\".s3-num\").text());\n                                                                orderitem.products.push(new product(name,  num ,price));\n                                                          });\n                                                          if(Date.parse(new Date()) < ((new Date(orderitem.time.split(\" \")[0])).getTime() + max_order_date * 24 * 60 * 60 * 1000)){\n                                                              if(globalInfo.order_info.order_detail.length < max_order_num){\n                                                                   globalInfo.order_info.order_detail.push(orderitem);\n                                                              }\n                                                          }\n                                                      }\n                                                      });\n                                         }));\n                    }\n\n\n                      $.when(task).done(function(){\n                           log(\"get page :\" + page);\n                           log(\"count: \" +globalInfo.order_info.order_detail.length );\n                           getPageOrder(page);\n                           globalInfo.order_info.order_detail.sort(compare());\n                      });\n\n               }else {\n                  log(\"finish\");\n                  saveInfo();\n                  session.setProgress(60);\n                  getUserInfo();\n                  return;\n               }\n           });\n       }\n       getPageOrder(1);\n    }\n\n    function compare(){\n        return function(a,b){\n            var value1 = (new Date(a.time.split(\" \")[0])).getTime();\n            var value2 = (new Date(b.time.split(\" \")[0])).getTime();\n            return value2 - value1;\n    }\n    }\n\n    function getUserInfo(){\n           location.href = \"http://home.m.jd.com/user/accountCenter.action\";\n    }\n    if (location.href.indexOf(\"://home.m.jd.com/user/accountCenter.action\") != -1 && location.href.indexOf(\"loginpage\") == -1) {\n        session.setProgress(70);\n        if($('#shimingrenzheng')[0] != undefined){\n           $('#shimingrenzheng')[0].click();\n        }\n    }\n\n    //已实名用户\n    if (location.href.indexOf(\"msc.jd.com/auth/loginpage/wcoo/toAuthInfoPage\") != -1) {\n        session.setProgress(90);\n        globalInfo = session.get(infokey);\n        if( $(\".pos-ab\")[0] != undefined){\n            globalInfo.base_info.name  = $(\".pos-ab\")[0].innerHTML;\n        }\n        if($(\".pos-ab\")[1] != undefined){\n            globalInfo.base_info.idcard_no  = $(\".pos-ab\")[1].innerHTML;\n        }\n        saveInfo();\n        logout();\n\n\n    }\n\n    function logout(){\n\n        //alert(\"爬取订单总计:\" + session.get(infokey).order_info.order_detail.length);\n        location.href = \"https://passport.m.jd.com/user/logout.action?sid=\"+session.get(\"sid\");\n        session.setProgress(100);\n        session.upload(session.get(infokey));\n        session.finish();\n    }\n    //快捷卡实名用户\n    if (location.href.indexOf(\"msc.jd.com/auth/loginpage/wcoo/toAuthPage\") != -1 ) {\n        session.setProgress(90);\n        globalInfo = session.get(infokey);\n        if($(\"#username\")[0] !=undefined){\n            globalInfo.base_info.name  = $(\"#username\")[0].innerHTML;\n        }\n        if($(\".info-user-name\")[0] !=undefined){\n                    globalInfo.base_info.name  = $(\".info-user-name\")[0].innerHTML;\n        }\n        if($(\"#idcard\")[0] !=undefined){\n            globalInfo.base_info.idcard_no  = $(\"#idcard\")[0].innerHTML;\n        }\n        if($(\".pos-ab[data-cardno]\") !=undefined){\n                    globalInfo.base_info.idcard_no  = $(\".pos-ab[data-cardno]\").attr(\"data-cardno\");\n        }\n\n        saveInfo();\n        logout();\n    }\n\n    function saveInfo(){\n        session.set(infokey, globalInfo);\n    }\n\n\n\n    function addr(name,phone,addrdetail) {\n        this.name = name;\n        this.phone = phone;\n        this.addrdetail = addrdetail;\n    }\n\n    var address = [];\n    var global_contact_info;\n\n\n    function info(base_info,contact_info,order_info ){\n        this.site_id = 2;\n    　　 this.base_info = base_info;\n    　　 this.contact_info = contact_info;\n    　　 this.order_info  = order_info;\n    }\n\n    function base_info(username, name, idcard_no, phone){\n        this.username = username;\n        this.name = name;\n        this.idcard_no = idcard_no;\n        this.phone = phone;\n    }\n\n\n    function contact_info(contact_detail){\n        this.contact_detail = contact_detail;\n    }\n\n    function contact(name, location ,address, phone, zipcode){\n        this.name  = name;\n        this.location  = location;\n        this.address  = address;\n        this.phone  = phone;\n        this.zipcode  = zipcode;\n    }\n\n    function order_info(order_detail){\n        this.order_detail  = order_detail;\n    }\n\n    function order(id, time , total, address){\n        this.id  = id;\n        this.time  = time;\n        this.total  = total;\n        this.address  = address;\n    }\n\n    function product(name, number, price){\n        this.name  = name;\n        this.number  = number;\n        this.price  = price;\n    }\n\n    // 增加判断当前页面是否是登录页  modify by renxin 2017.1.17\n    if ($(\"#loginOneStep\").length && $(\"#loginOneStep\").length > 0) {\n      session.setStartUrl();\n    }\n\n\n//end\n})"]}